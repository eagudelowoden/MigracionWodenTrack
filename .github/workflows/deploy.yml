name: Deploy WodenTrack V2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Compilar y Desplegar NestJS + Frontend
        uses: appleboy/ssh-action@master
        with:
          host: 18.217.246.39
          username: Administrator
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Tiempo de espera extendido porque los builds tardan
          command_timeout: 10m
          script: |
            @echo off
            cd /d C:\Users\Administrator\Documents\WodenTrackV2
            
            echo --- 1. ACTUALIZANDO REPOSITORIO ---
            git fetch --all
            git reset --hard origin/main

            echo --- 2. TRABAJANDO EN BACKEND (NestJS) ---
            cd backend
            call npm install
            echo Compilando NestJS...
            call npm run build
            :: Reiniciamos PM2 apuntando al archivo compilado
            pm2 restart woden-track-backend --update-env || pm2 start dist/main.js --name woden-track-backend
            cd ..

            echo --- 3. TRABAJANDO EN FRONTEND ---
            cd frontend
            call npm install
            echo Compilando Frontend...
            call npm run build
            
            echo --- 4. DESPLEGANDO A IIS ---
            :: Limpiamos la carpeta de IIS usando PowerShell para evitar errores de archivos bloqueados
            powershell -Command "if (Test-Path 'C:\inetpub\wwwroot\WodenTrack\dist') { Remove-Item 'C:\inetpub\wwwroot\WodenTrack\dist\*' -Recurse -Force }"
            :: Copiamos el build fresco
            xcopy /E /Y /I "dist\*" "C:\inetpub\wwwroot\WodenTrack\dist"

            echo --- [OK] DESPLIEGUE FINALIZADO CORRECTAMENTE ---