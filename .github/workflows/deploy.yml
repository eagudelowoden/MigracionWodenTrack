name: Deploy WodenTrack V2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Compilar y Desplegar NestJS + Frontend
        uses: appleboy/ssh-action@master
        with:
          host: 18.217.246.39
          username: Administrator
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 15m
          script: |
            @echo off
            :: Definir ruta del log
            set LOG_FILE="C:\Users\Administrator\Documents\WodenTrackV2\deploy_results.txt"
            
            echo ------------------------------------------ >> %LOG_FILE%
            echo FECHA: %date% %time% >> %LOG_FILE%
            cd /d C:\Users\Administrator\Documents\WodenTrackV2

            echo --- 1. ACTUALIZANDO REPOSITORIO ---
            echo [LOG] Actualizando codigo desde Git... >> %LOG_FILE%
            git fetch --all >> %LOG_FILE% 2>&1
            git reset --hard origin/main >> %LOG_FILE% 2>&1

            echo --- 2. TRABAJANDO EN BACKEND (NestJS) ---
            cd backend
            echo [LOG] Instalando dependencias Backend... >> %LOG_FILE%
            call npm install >> %LOG_FILE% 2>&1
            echo [LOG] Compilando NestJS... >> %LOG_FILE%
            call npm run build >> %LOG_FILE% 2>&1
            
            echo [LOG] Gestionando servicio PM2... >> %LOG_FILE%
            :: Intenta reiniciar, si falla (porque no existe), lo inicia
            pm2 restart woden-track-backend --update-env >> %LOG_FILE% 2>&1 || pm2 start dist/main.js --name woden-track-backend >> %LOG_FILE% 2>&1
            cd ..

            echo --- 3. TRABAJANDO EN FRONTEND ---
            cd frontend
            echo [LOG] Instalando dependencias Frontend... >> %LOG_FILE%
            call npm install >> %LOG_FILE% 2>&1
            echo [LOG] Compilando Frontend... >> %LOG_FILE%
            call npm run build >> %LOG_FILE% 2>&1
            
            echo --- 4. DESPLEGANDO A IIS ---
            echo [LOG] Limpiando carpeta IIS y copiando archivos... >> %LOG_FILE%
            powershell -Command "if (Test-Path 'C:\inetpub\wwwroot\WodenTrack\dist') { Remove-Item 'C:\inetpub\wwwroot\WodenTrack\dist\*' -Recurse -Force }" >> %LOG_FILE% 2>&1
            xcopy /E /Y /I "dist\*" "C:\inetpub\wwwroot\WodenTrack\dist" >> %LOG_FILE% 2>&1

            echo [OK] DESPLIEGUE FINALIZADO EN: %time% >> %LOG_FILE%
            echo ------------------------------------------ >> %LOG_FILE%
            
            echo --- [OK] PROCESO TERMINADO ---