name: Deploy WodenTrack V2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Compilar y Desplegar con Logs
        uses: appleboy/ssh-action@master
        with:
          host: 18.217.246.39
          username: Administrator
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 15m
          script: |
            powershell -Command "& {
                $logFile = 'C:\Users\Administrator\Documents\WodenTrackV2\deploy_log.txt'
                $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
                
                # FunciÃ³n para escribir en consola y en el archivo de log al mismo tiempo
                function Write-Log {
                    param([string]$Message)
                    $msg = \"[$timestamp] $Message\"
                    Write-Host $msg
                    $msg | Out-File -FilePath $logFile -Append -Encoding UTF8
                }

                Write-Log '--- INICIANDO DESPLIEGUE ---'
                cd C:\Users\Administrator\Documents\WodenTrackV2

                Write-Log '1. Actualizando repositorio...'
                git fetch --all 2>&1 | Out-File -FilePath $logFile -Append
                git reset --hard origin/main 2>&1 | Out-File -FilePath $logFile -Append

                Write-Log '2. Configurando Backend (NestJS)...'
                cd backend
                npm install 2>&1 | Out-File -FilePath $logFile -Append
                Write-Log 'Compilando NestJS...'
                npm run build 2>&1 | Out-File -FilePath $logFile -Append
                
                Write-Log 'Reiniciando PM2...'
                pm2 restart woden-track-backend --update-env 2>&1 | Out-File -FilePath $logFile -Append
                if ($LASTEXITCODE -ne 0) {
                    pm2 start dist/main.js --name woden-track-backend 2>&1 | Out-File -FilePath $logFile -Append
                }

                Write-Log '3. Configurando Frontend...'
                cd ../frontend
                npm install 2>&1 | Out-File -FilePath $logFile -Append
                Write-Log 'Compilando Frontend...'
                npm run build 2>&1 | Out-File -FilePath $logFile -Append

                Write-Log '4. Desplegando a IIS...'
                if (Test-Path 'C:\inetpub\wwwroot\WodenTrack\dist') {
                    Remove-Item 'C:\inetpub\wwwroot\WodenTrack\dist\*' -Recurse -Force -ErrorAction SilentlyContinue
                }
                xcopy /E /Y /I 'dist\*' 'C:\inetpub\wwwroot\WodenTrack\dist' 2>&1 | Out-File -FilePath $logFile -Append

                Write-Log '--- DESPLIEGUE FINALIZADO EXITOSAMENTE ---'
            }"