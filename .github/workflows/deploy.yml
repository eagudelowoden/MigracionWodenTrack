name: Deploy WodenTrack V2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Compilar y Desplegar NestJS + Frontend
        uses: appleboy/ssh-action@master
        with:
          host: 18.217.246.39
          username: Administrator
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 20m
          script: |
            :: 1. Entrar a la carpeta raíz (Asegúrate que esta ruta es la real)
            cd /d "C:\Users\Administrator\Documents\WodenTrackV2"
            
            :: Crear log inicial
            echo --- INICIO DE SESION %date% %time% --- > deploy_results.txt

            :: 2. Actualizar GIT con salida forzada
            echo [GIT] Bajando cambios...
            git fetch --all >> deploy_results.txt 2>&1
            git reset --hard origin/main >> deploy_results.txt 2>&1

            :: 3. BACKEND - NestJS
            echo [BACKEND] Entrando a carpeta backend...
            cd /d "C:\Users\Administrator\Documents\WodenTrackV2\backend"
            echo [BACKEND] Instalando...
            call npm install >> ../deploy_results.txt 2>&1
            echo [BACKEND] Compilando...
            call npm run build >> ../deploy_results.txt 2>&1
            
            echo [BACKEND] Reiniciando PM2...
            :: Usamos el path completo para PM2 por si no está en el PATH del SSH
            call pm2 restart dist/main.js --name woden-track-backend >> ../deploy_results.txt 2>&1 || call pm2 start dist/main.js --name woden-track-backend >> ../deploy_results.txt 2>&1

            :: 4. FRONTEND
            echo [FRONTEND] Entrando a carpeta frontend...
            cd /d "C:\Users\Administrator\Documents\WodenTrackV2\frontend"
            echo [FRONTEND] Instalando...
            call npm install >> ../deploy_results.txt 2>&1
            echo [FRONTEND] Compilando...
            call npm run build >> ../deploy_results.txt 2>&1

            :: 5. DESPLIEGUE IIS
            echo [IIS] Copiando archivos...
            powershell -Command "if (Test-Path 'C:\inetpub\wwwroot\WodenTrack\dist') { Remove-Item 'C:\inetpub\wwwroot\WodenTrack\dist\*' -Recurse -Force }"
            xcopy /E /Y /I "dist\*" "C:\inetpub\wwwroot\WodenTrack\dist" >> ../deploy_results.txt 2>&1

            echo --- PROCESO TERMINADO --- >> ../deploy_results.txt