name: Deploy WodenTrack V2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Ejecutar Despliegue
        uses: appleboy/ssh-action@master
        with:
          host: 18.217.246.39
          username: Administrator
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 20m
          script: |
            cd /d C:\Users\Administrator\Documents\WodenTrackV2
            echo "--- INICIO ---" > deploy_results.txt
            
            echo "1. Git..." >> deploy_results.txt
            git fetch --all >> deploy_results.txt 2>&1
            git reset --hard origin/main >> deploy_results.txt 2>&1
            
            echo "2. Backend..." >> deploy_results.txt
            call npm install >> deploy_results.txt 2>&1
            call npm run build >> deploy_results.txt 2>&1
            
            echo "3. PM2..." >> deploy_results.txt
            call pm2 restart dist/main.js --name woden-track-backend >> deploy_results.txt 2>&1 || call pm2 start dist/main.js --name woden-track-backend >> deploy_results.txt 2>&1
            
            echo "4. Frontend..." >> deploy_results.txt
            cd frontend
            call npm install >> ../deploy_results.txt 2>&1
            call npm run build >> ../deploy_results.txt 2>&1
            
            echo "5. IIS..." >> ../deploy_results.txt
            powershell -Command "if (Test-Path 'C:\inetpub\wwwroot\WodenTrack\dist') { Remove-Item 'C:\inetpub\wwwroot\WodenTrack\dist\*' -Recurse -Force }"
            xcopy /E /Y /I "dist\*" "C:\inetpub\wwwroot\WodenTrack\dist" >> ../deploy_results.txt 2>&1
            
            echo "--- FIN ---" >> ../deploy_results.txt